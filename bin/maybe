#!/usr/bin/env python
"""Maybe run a command if something has changed in a folder

Usage:
  maybe command <command> [--from=<from_commit> [--to=<to_commit>]]
  maybe diff [--from=<from_commit> [--to=<to_commit>]]
  maybe (-h | --help)
  maybe --version

Options:
  --from=<from_commit>  The commit or reference to compare from
  --to=<to_commit>      The commit or reference to compare to
  -h --help             Show this screen
  --version             Show version

"""
from __future__ import print_function, unicode_literals

import os
import sys

from docopt import docopt

import maybe
from maybe.cli import CLI


def get_config_file(filename='Maybefile'):
    if os.path.exists(filename):
        return os.path.abspath(filename)

    raise Exception('No "Maybefile" available')


if __name__ == '__main__':
    arguments = docopt(__doc__, version='Maybe {0}'.format(maybe.__version__))

    cli = CLI(config=maybe.read_config(get_config_file()))

    if arguments['command'] or arguments['cmd']:
        changed_projects = cli.changed_projects(
            from_commit=arguments['--from'],
            to_commit=arguments['--to'],
        )

        print('Changed paths:')
        for project in changed_projects:
            print('\t{0}'.format(project))
        print()

        results = cli.run(
            command_name=arguments['<command>'],
            paths=changed_projects,
        )

        for result in results:
            print('{}: {} ({})'.format(result.path,
                                       'Success' if result.success else 'Failure',
                                       result.run_time))
        print()
        print('Commands finished in {}'.format(results.run_time))

        exit(0 if results else 1)
    else:
        print('I have no idea how we ended up here', file=sys.stderr)
        print(__doc__)
        exit(1)
