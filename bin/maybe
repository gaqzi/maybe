#!/usr/bin/env python
"""Maybe run a command if something has changed in a folder

Usage:
  maybe run <command> [<from_commit> [<to_commit>]]
  maybe diff [<from_commit> [<to_commit>]]
  maybe (-h | --help)
  maybe --version

Options:
  -h --help   Show this screen
  --version   Show version

"""
from __future__ import print_function, unicode_literals

import os
import sys

from docopt import docopt

import maybe
from maybe.cli import CLI


def get_config_file(filename='Maybefile'):
    if os.path.exists(filename):
        return os.path.abspath(filename)

    raise Exception('No "Maybefile" available')


if __name__ == '__main__':
    arguments = docopt(__doc__, version='Maybe {0}'.format(maybe.__version__))

    cli = CLI(config=maybe.read_config(get_config_file()))

    if arguments['run']:
        changed_projects = cli.changed_projects(
            from_commit=arguments['<from_commit>'],
            to_commit=arguments['<to_commit>'],
        )

        result = cli.run(
            command=arguments['<command>'],
            paths=changed_projects,
        )
    elif arguments['diff']:
        result = cli.changed_projects(
            from_commit=arguments['<from_commit>'],
            to_commit=arguments['<to_commit>'],
        )

        if result:
            for folder in result:
                print('\t{0}'.format(folder))
        else:
            print('Nothing changed.')
    else:
        print('I have no idea how we ended up here', file=sys.stderr)
        print(__doc__)
        exit(1)

    exit(0 if result else 1)
